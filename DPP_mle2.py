import numpy as np
import matplotlib.pyplot as plt
import scipy.stats
import random
import math

X6=[[0.3792867335276325, 1.950488939292105], [0.12836889952507655, 0.20422533212852556], [0.489839037603313, 1.0273893483232186], [2.335239047338269, 2.511976341084248], [1.3055910883453483, 2.637418599488819], [2.9759270608282127, 0.07360707763577042], [1.330170795446663, 1.0778910731277673], [1.2100331530385762, 0.6106031429272996], [0.5709854814314912, 2.6092288209158254], [1.1097074958185458, 2.011440897921088], [1.9132724540760757, 1.203330056366217], [0.6482589481773727, 2.8543958151486577], [2.825262683728557, 0.8930673855843748], [2.075748714827975, 2.839466302721716], [2.6076559478388375, 2.1927193749081915], [1.464884193220323, 1.5249772140336393], [0.9052726934361649, 1.9970141000243289], [0.5617283790619311, 1.1748829956169933], [2.9802233404979397, 1.2824176965655991], [2.998508951911826, 2.1119687394629825], [2.8250395472042946, 2.982804664611138], [0.2806847789120289, 2.431655871357795], [1.7245952111918592, 2.3166104208351617], [0.16081087645167588, 0.14508724965147393], [0.5160095277486658, 1.3812410548991672], [1.4742473505336864, 2.051746673773112], [2.5543864162375267, 2.304326182639277], [1.323556787893661, 1.1926374540175682], [2.0793921344001975, 0.8567381201411894]]

X6=[[1.5139235171749965, 2.3671040321985957], [2.8455477079235707, 0.6093582344416864], [2.1357172411851146, 0.7003372026200755], [0.11530635518683878, 2.8955613093597927], [0.2360680324918702, 0.47072544290537854], [1.361902039516922, 1.2737102183060829], [1.557142955977553, 0.5464503636251492], [0.10851869888707558, 1.7300772893377137], [0.24241053822927927, 0.05917149298866799], [3.07058826981213, 1.0659060513117604], [2.2737569764272987, 2.2802006967531296], [1.60664407703972, 2.7251295133339966], [2.6763352353249488, 2.108389599860413], [1.0897474042036641, 2.9062854477467295], [1.9582434366341033, 1.9461375286433922], [2.0549805530975838, 2.6477832295804253], [2.466608429694391, 2.6072578889153917], [1.3687892233689056, 0.5711301235010718], [0.15874081550130692, 1.6340660588240505], [0.6100819855431119, 1.9264965332750463]]


Xopt=[0.6778141,0.6200708,0.7086080,0.7454694,0.6404197
,0.5947815
,0.6140332
,0.7615782
,0.7916968
,0.6655731
,0.5157943
, 0.5480846
, 0.7199825
, 0.7436936
, 0.7557857
, 0.7310834
, 0.7176381
, 0.7121444
, 0.2568846
, 0.8056544
, 0.6289476
, 0.7079516
, 0.7955864
, 0.4681896
, 0.7076288
, 0.6482895
, 0.7099390
, 0.7679365
, 0.7081029
, 0.6980523
, 0.7175349
, 0.6404663
, 0.7978994
, 0.6947298
, 0.7516676
, 0.8171450
, 0.7367751
, 0.8287710
, 0.4949641
, 0.6525753]

Xopt=[0.18432171
 , 0.31725565
 , 0.79632922
 , 0.81164443
 , 0.47883381
 , 0.19536589
 , 0.40457973
 , 0.50463822
 , 0.58310061
, 0.48496572
, 0.64553830
, 0.21541638
, 0.47943749
, 0.41939318
, 0.52233836
, 0.56858192
, 0.72510623
, 0.67537542
, 0.75743111
, 0.66729364
, 0.47193002
, 0.73289932
, 0.43598724
, 0.57258313
, 0.42533295
, 0.51871007
, 0.22052689
, 0.60248602
, 0.33834092
, 0.38339733
, 0.61493419
, 0.29001503
, 0.73117374
, 0.74379436
, 0.47649928
, 0.69038702
, 0.08047325
, 0.59866841
, 0.33147147
, 0.30344232]

m=40
lis=[i for i in range(m)]
"""
lam_num_list=[]
for i in range(100):
    lam_num=sorted(random.sample(lis,len(X6)))
    if not lam_num in lam_num_list:
        lam_num_list.append(lam_num)
    if len(lam_num_list)==50:
        break
"""

#print(lam_num_list)

def K(x,y,lam):
    vec=0.0
    #print("sssssssssssss")
    for i in range(m):
        vec+= lam[i]/(1.0-lam[i]) * 4/(np.pi)**2  * math.sin((i+1)*x[0])*math.sin((i+1)*x[1])  * math.sin((i+1)*y[0])*math.sin((i+1)*y[1])
    #print("vec=",vec)
    return vec

def Phi(lam,phi):
    A=np.ones((len(phi),len(phi)))
    for x1 in range(len(phi)):
        for x2 in range(len(phi)):
            #print(phi[x1])
            #print(lam)
            #print("dede")
            #print(K(phi[x1],phi[x2],lam))
            A[x1][x2]=K(phi[x1],phi[x2],lam)
    print(A)
    #print(math.log(np.linalg.det(A).real))
    return np.linalg.det(A)

def log1(lam):
    vv=0
    for i in lis:
        vv+=math.log(1-lam[i])
    return vv

lamda=[0.2,0.3,0.5,0.7,0.8]

lamlist=[]
for i in range(500):
    lam=[]
    for i in range(m):
        lam.append(lamda[np.random.randint(0,len(lamda))])
    if not lam in lamlist:
        lamlist.append(lam)
print(lamlist)

#lamの組み合わせと、lam_numの組み合わせを決定した。全部の尤度を計算する。
#真の値
print("--------------")
L=[]
for LL in range(20):
    L.append(0.7)
for LL in range(20):
    L.append(0.3)
KKK=Phi(L,X6)
print("det(K')=",KKK)
fff=log1(L)+math.log(KKK)
print("lamda=",L)
print("logf(phi)=",fff)
efff=math.e**fff
print("f(phi)=",efff)
print("--------------")

print("--------------")
KKKopt=Phi(Xopt,X6)
print("logdet(K')=",math.log(KKKopt))
fffopt=log1(Xopt)+math.log(KKKopt)
print("log1(X)=",log1(Xopt))
print("lamda=",Xopt)
print("logf(phi)=",fffopt)
efffopt=math.e**fffopt
print("f(phi)=",efffopt)
print("--------------")


flist=[]
for i in range(len(lamlist)):
    KK=Phi(lamlist[i],X6)
    print("det(K')=",KK)
    if not KK < 0.001:
        f=log1(lamlist[i])+math.log(KK)
        print("lamda=",lamlist[i])
        print("logf(phi)=",f)
        ff=math.e**f
        print("f(phi)=",ff)
        flist.append(f)

print(flist)
print("max=",max(flist))
print("lamda on max=",lamlist[flist.index(max(flist))])

#plt.figure(figsize=(10, 10), dpi=50)
#for i in range(len(lamlist)):
plt.plot(range(len(flist)),flist)
plt.hlines([fff],1,len(flist),"green",label="true value")
plt.hlines([fffopt],1,len(flist),"red",label="estimated value")
plt.xlabel("trial")
plt.ylabel("logf(φ)")
plt.show()
print("logf===",fff)
